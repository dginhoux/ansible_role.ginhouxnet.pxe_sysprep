################################################################################
### Mirror settings
################################################################################
url --url={_{_{_ pxe_deploy_fedora_37_mirror_url _}_}_}

################################################################################
### Account setup
################################################################################
rootpw --plaintext {_{_{_ server.rootpwd _}_}_}
# auth --passalgo=sha512 --useshadow

################################################################################
### Localization
################################################################################
lang {_{_{_ server.locale _}_}_}
keyboard {_{_{_ server.kblayout _}_}_}

################################################################################
### Clock and time zone setup
################################################################################
timezone {_{_{_ server.timezone _}_}_} --isUtc

################################################################################
### Options
################################################################################
selinux --disabled
firewall --disabled
text
firstboot --disable
# install
reboot
skipx

################################################################################
### Partitioning
################################################################################
zerombr
clearpart --all --initlabel --drives={_{_{_ server.disk _}_}_}

{% if server.partitionning == 'nolvm-single' %}
part /boot/efi --size 128 --asprimary --fstype=efi --fsoptions="umask=0777,shortname=winnt" --ondisk={_{_{_ server.disk _}_}_}
part / --size 1 --grow --asprimary --fstype={_{_{_ server.filesystem | default('ext4') _}_}_} --ondisk={_{_{_ server.disk _}_}_}
{% endif %}

{% if server.partitionning == 'lvm-multi' %}
part /boot/efi --size 128 --asprimary --fstype=efi --fsoptions="umask=0777,shortname=winnt" --ondisk={_{_{_ server.disk _}_}_}
part /boot --fstype={_{_{_ server.filesystem_boot | default('ext2') _}_}_} --size=512 --ondisk={_{_{_ server.disk _}_}_}
part pv.1 --size 1 --grow --fstype=lvmpv --ondisk={_{_{_ server.disk _}_}_}
volgroup {_{_{_ server.vgname | default('vg0') _}_}_} --pesize=32768 pv.1
logvol / --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=4096 --name=lv-root
logvol /var --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=2048 --name=lv-var
logvol /home --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=1024 --name=lv-home
logvol /tmp --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=1024 --name=lv-tmp
logvol swap --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=2048 --name=lv-swap
{% endif %}

{% if server.partitionning == 'lvm-multi2' %}
part /boot/efi --size 256 --asprimary --fstype=efi --fsoptions="umask=0777,shortname=winnt" --ondisk={_{_{_ server.disk _}_}_}
part /boot --fstype={_{_{_ server.filesystem_boot | default('ext2') _}_}_} --size=512 --ondisk={_{_{_ server.disk _}_}_}
part pv.1 --size 1 --grow --fstype=lvmpv --ondisk={_{_{_ server.disk _}_}_}
volgroup {_{_{_ server.vgname | default('vg0') _}_}_} --pesize=32768 pv.1
logvol / --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=2048 --name=lv-root
logvol /usr --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=4096 --name=lv-usr
logvol /var --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=2048 --name=lv-var
logvol /home --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=1024 --name=lv-home
logvol /tmp --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=1024 --name=lv-tmp
logvol /opt --fstype {_{_{_ server.filesystem | default('ext4') _}_}_} --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=1024 --name=lv-opt
logvol swap --vgname {_{_{_ server.vgname | default('vg0') _}_}_} --size=2048 --name=lv-swap
{% endif %}

################################################################################
### Boot loader installation
################################################################################
bootloader --location=mbr --append="crashkernel=auto" --boot-drive={_{_{_ server.disk _}_}_}

################################################################################
### Network configuration
################################################################################
network --hostname {_{_{_ server.name _}_}_}
network --activate --onboot=yes --bootproto=dhcp

################################################################################
### Package selection
################################################################################
%packages --ignoremissing
@standard
@base
@core
@system-admin-tools
iotop
haveged
nmon
qemu-guest-agent
vim
sudo
htop
tig
git
wget
sshpass
zip
nmap
sysstat
tree
nfs-utils
sed
sysfsutils
rsync
nano
findutils
tar
net-tools
lsof
curl
which
bind-utils
ntp
man
gzip
nmap
screen
-subscription-manager
-sysreport
%end

################################################################################
### Running custom commands during the installation
################################################################################
%post --interpreter=/bin/bash
sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config;
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config;
%end
